# vim:set sw=8 ts=8 noet:
#
# Copyright (c) 2016-2017 Torchbox Ltd.
#
# Permission is granted to anyone to use this software for any purpose,
# including commercial applications, and to alter it and redistribute it
# freely.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

TS_INCDIR=	@TS_INCDIR@
TS_PLUGINDIR=	@TS_PLUGINDIR@

VERSION?=	unversioned

ROOT=		@top_srcdir@

CC=		@CC@
CXX=		@CXX@
CPPFLAGS=	@CPPFLAGS@		\
		-I${TS_INCDIR}		\
		-I${ROOT}		\
		-I${ROOT}/gtest		\
		-I${ROOT}/gtest/include	\
		-I${ROOT}/api		\
		-I${ROOT}/util

CFLAGS=		@TS_CFLAGS@ @JSON_CFLAGS@ @PTHREAD_CFLAGS@ @CFLAGS@
CXXFLAGS=	@TS_CXXFLAGS@ @JSON_CFLAGS@ @CXXFLAGS@
LIBS=		@LIBS@ @LDFLAGS@ @JSON_LIBS@

PTHREAD_LIBS=	@PTHREAD_LIBS@

VPATH=		${ROOT}/crypt		\
		${ROOT}/util		\
		${ROOT}/api		\
		${ROOT}/tests		\
		${ROOT}/gtest/src

CRYPT_SRCS=	crypt.c		\
		crypt_des.c	\
		crypt_bf.c	\
		crypt_sha256.c	\
		crypt_sha512.c	\
		crypt_md5.c
CRYPT_OBJS=	${CRYPT_SRCS:.c=.o}

API_SRCS=	cluster.c	\
		ingress.c	\
		secret.c	\
		service.c	\
		endpoints.c	\
		namespace.c
API_OBJS=	${API_SRCS:.c=.o}

SRCS=		hash.c		\
		config.c	\
		watcher.c	\
		synth.c		\
		remap.c		\
		tls.c		\
		plugin.c	\
		base64.c	\
		${CRYPT_SRCS}	\
		${API_SRCS}
OBJS=		${SRCS:.c=.o}

TEST_OBJS=	gtest-all.o	gtest_main.o	\
		base64.o	test_base64.o	\
		hash.o		test_hash.o	\
		${API_OBJS}	test_api.o	\
		${CRYPT_OBJS}	test_crypt.o

DISTFILES=	api crypt util			\
		config.h plugin.h synth.h tls.h	\
		ts_crypt.h watcher.h		\
		config.c namespace.c plugin.c	\
		remap.c synth.c tls.c watcher.c	\
		gtest				\
		tests				\
		configure			\
		configure.ac			\
		acinclude			\
		aclocal.m4			\
		autoconf.h.in			\
		config.guess			\
		config.sub			\
		install-sh			\
		kubernetes.config.example	\
		test.htpasswd			\
		Dockerfile			\
		Makefile.docker			\
		Makefile.in			\
		README.md			\
		docker				\
		example-daemonset.yaml

all: kubernetes.so

kubernetes.so: ${OBJS}
	${CC} ${CFLAGS} ${LDFLAGS} -shared -o $@ ${OBJS} ${LIBS}

test: ${TEST_OBJS} ${GTEST_OBJS}
	${CXX} ${CXXFLAGS} ${LDFLAGS} ${TEST_OBJS} ${GTEST_OBJS} -o test ${LIBS} ${PTHREAD_LIBS}
	./test

install: all
	install -d -m 0755 ${TS_PLUGINDIR}
	install -c -m 0755 kubernetes.so ${TS_PLUGINDIR}

%.o: %.c
	${CC} ${CPPFLAGS} ${CFLAGS} -c $<

%.o: %.cc
	${CXX} ${CPPFLAGS} ${CXXFLAGS} -c $<

lint: ${SRCS}
	${CC} ${CPPFLAGS} ${CFLAGS} --analyze $?

clean:
	rm -f kubernetes.so ${OBJS} ${TEST_OBJS} *.plist test

release:
	rm -rf k8s-ts-ingress-${VERSION}
	mkdir -p k8s-ts-ingress-${VERSION}
	tar cf - ${DISTFILES} | tar xf - -C k8s-ts-ingress-${VERSION}
	tar cf - k8s-ts-ingress-${VERSION} | gzip > release.tar.gz
	ls -oh release.tar.gz

depend:
	sed -e '/^# ADDED BY MAKE DEPEND -- DO NOT DELETE/,$$ d' < Makefile > Makefile.tmp
	echo '# ADDED BY MAKE DEPEND -- DO NOT DELETE' >> Makefile.tmp
	${CC} ${CPPFLAGS} ${CFLAGS} ${JSON_CFLAGS} -MM \
		*.c crypt/*.c >> Makefile.tmp
	${CXX} ${CPPFLAGS} ${CXXFLAGS} ${JSON_CFLAGS} -MM \
		tests/*.cc >> Makefile.tmp
	mv Makefile.tmp Makefile

.PHONY: test
