# vim:set sw=8 ts=8 noet:
#
# Copyright (c) 2016-2017 Torchbox Ltd.
#
# Permission is granted to anyone to use this software for any purpose,
# including commercial applications, and to alter it and redistribute it
# freely.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

DOCKER_REGISTRY?=	torchbox/k8s-ts-ingress
DOCKER_TAG?=		1.0-dev
DOCKER_IMAGE=		${DOCKER_REGISTRY}:${DOCKER_TAG}

TS_INCDIR=	@TS_INCDIR@
TS_PLUGINDIR=	@TS_PLUGINDIR@

CC=		@CC@
CPPFLAGS=	@CPPFLAGS@ -I${TS_INCDIR}
CFLAGS=		@TS_CFLAGS@ @JSON_CFLAGS@ @CFLAGS@
LIBS=		@LIBS@ @LDFLAGS@ @JSON_LIBS@

OBJS=		hash.o		\
		config.o	\
		cluster.o	\
		ingress.o	\
		secret.o	\
		service.o	\
		endpoints.o	\
		namespace.o	\
		watcher.o	\
		synth.o		\
		remap.o		\
		tls.o		\
		plugin.o	\
		${HASH_OBJS}

all: kubernetes.so

kubernetes.so: ${OBJS}
	${CC} ${CFLAGS} ${LDFLAGS} -shared -o $@ ${OBJS} ${LIBS}

install: all
	install -d -m 0755 ${TS_PLUGINDIR}
	install -c -m 0755 kubernetes.so ${TS_PLUGINDIR}

.c.o:
	${CC} ${CPPFLAGS} ${CFLAGS} -c $<

clean:
	rm -f kubernetes_tls.so ${OBJS}

docker-build:
	docker build --pull -t ${DOCKER_IMAGE} .

docker-push:
	docker push ${DOCKER_IMAGE}

depend:
	sed -e '/^# ADDED BY MAKE DEPEND -- DO NOT DELETE/,$$ d' < Makefile > Makefile.tmp
	echo '# ADDED BY MAKE DEPEND -- DO NOT DELETE' >> Makefile.tmp
	cc -MM *.c >> Makefile.tmp
	mv Makefile.tmp Makefile

hashtest:
	${CC} -DTEST hash.c -o hashtest
	./hashtest

.PHONY: hashtest
